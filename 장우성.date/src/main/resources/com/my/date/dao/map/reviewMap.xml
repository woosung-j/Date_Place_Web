<?xml version='1.0' encoding='utf-8' ?>
<!DOCTYPE mapper PUBLIC '-//mybatis.org//DTD Mapper 3.0//EN'
	'http://mybatis.org/dtd/mybatis-3-mapper.dtd'>
<mapper namespace='com.my.date.dao.map.ReviewMap'>
	<select id='selectReviewsByPlaceId' resultMap='reviewsMap'>
		select  r.review_id, r.place_id, p.place_name, r.user_id, u.profile_image, u.nickname, 
                r.content, r.star_rating, i.file_name, i.reviewimages_id, r.created_at
		from reviews r
		left join review_images i on i.review_id = r.review_id
        left join users u on r.user_id = u.user_id
        left join places p on r.place_id = p.place_id
		where r.place_id = #{placeId}
		order by review_id
	</select>

	<select id='selectReviewAvg' resultType='string'>
		select ROUND(avg(star_rating), 2)
		from reviews
		where place_id = #{placeId}
		group by place_id
	</select>
	
	<insert id='insertReview'>
		insert into reviews values(REVIEWS_id_SEQ.nextval, #{placeId}, #{userId}, #{content}, #{starRating}, sysdate)
	</insert>
	
	<resultMap id='reviewsMap' type='ReviewDto'>
		<id property='reviewId' column='review_id' />
		<result property='placeId' column='place_id' />
		<result property='userId' column='user_id' />
		<result property='content' column='content' />
		<result property='starRating' column='star_rating' />
		<result property='createdAt' column='created_at' />
		<result property='nickname' column='nickname' />
		<result property='profileImage' column='profile_image'/>
		<result property='placeName' column='place_name' />
		<collection property='reviewImages' resultMap='reviewImageMap' />
	</resultMap>
	
	<resultMap id='reviewImageMap' type='com.my.date.domain.ReviewImage'>
		<id property='reviewImagesId' column='reviewimages_id'/>
		<result property='fileName' column='file_name'/>
	</resultMap>
</mapper>

		