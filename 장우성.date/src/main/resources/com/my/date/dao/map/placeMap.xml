<?xml version='1.0' encoding='utf-8' ?>
<!DOCTYPE mapper PUBLIC '-//mybatis.org//DTD Mapper 3.0//EN'
	'http://mybatis.org/dtd/mybatis-3-mapper.dtd'>
<mapper namespace='com.my.date.dao.map.PlaceMap'>
	<select id='selectPlaces' resultType='place'>
		select place_id, place_name, si_id, gu_id, place_group_id, introduction
		from places
		order by place_id
	</select>
	
	<select id='selectPlace' resultType='place'>
		select place_id, place_name
		from places
		where place_id = #{placeId}
	</select>
	
	<insert id='insertPlace'>
		insert into places values(places_id_seq.nextval, #{placeName}, #{placeInfo}
			#{si_id}, #{gu_id}, #{placeGroupId}, createAt_now, sysdate)
	</insert>
	
	<update id='updatePlace'>
		update places
		set place_name = #{placeName}, introduction = #{placeInfo},
			si_id = #{siId}, gu_id = #{guId}, place_group_id = #{placeGroupId},
			sysdate, updateAt_now
		where place_id = #{placeId}
	</update>
	
	<delete id='deletePlace'>
		delete places
		where place_id = #{placeId}
	</delete>

	<select id="selectPlaceByPlaceId" resultMap="placeDetailMap">
		select p.place_id, p.place_name, p.introduction, p.views, p.place_group_id, p.created_at, p.updated_at,
		    d.detail_id, d.address, d.tel, d.opening_hours, d.closing_hours, d.day_off, d.contact, d.parking,
		    m.menu_id, m.menu_name, m.price, pi.place_image_id, pi.file_name,
		    (select count(*) from my_places m where m.place_id = #{placeId}) as place_like_count,
		    (select my_place_id from my_places m where m.place_id = #{placeId} and m.user_id = #{userId}) as is_like
		from places p
		left join details d on p.place_id = d.place_id
		left join menus m on p.place_id = m.place_id
		left join place_images pi on p.place_id = pi.place_id
		where p.place_id = #{placeId}
	</select>

	<select id="selectAdminPlaceByPlaceId" resultMap="placeDetailMap">
		select p.place_id, p.place_name, p.introduction, p.views, p.place_group_id, p.created_at, p.updated_at,
			d.detail_id, d.address, d.tel, d.opening_hours, d.closing_hours, d.day_off, d.contact, d.parking,
			m.menu_id, m.menu_name, m.price, pi.place_image_id, pi.file_name,
			(select count(*) from my_places m where m.place_id = #{placeId}) as place_like_count
		from places p
			left join details d on p.place_id = d.place_id
			left join menus m on p.place_id = m.place_id
			left join place_images pi on p.place_id = pi.place_id
		where p.place_id = #{placeId}
	</select>

	<resultMap id="placeDetailMap" type="placeDetailDto">
		<id property="placeId" column="place_id"/>
		<result property="placeName" column="place_name"/>
		<result property="introduction" column="introduction"/>
		<result property="views" column="views"/>
		<result property="placeGroupId" column="place_group_id"/>
		<result property="createdAt" column="created_at"/>
		<result property="updatedAt" column="updated_at"/>
		<result property="placeLikeCount" column="place_like_count"/>
		<result property="isLike" column="is_like"/>
		<association property="detail" resultMap="detailMap"/>
		<collection property="menus" resultMap="menuMap"/>
		<collection property="placeImages" resultMap="placeImageMap"/>
	</resultMap>

	<resultMap id="detailMap" type="detail">
		<id property="detailId" column="detail_id"/>
		<result property="address" column="address"/>
		<result property="tel" column="tel"/>
		<result property="openingHours" column="opening_hours"/>
		<result property="closingHours" column="closing_hours"/>
		<result property="dayOff" column="day_off"/>
		<result property="contact" column="contact"/>
		<result property="parking" column="parking"/>
	</resultMap>

	<resultMap id="menuMap" type="Menu">
		<id property="menuId" column="menu_id"/>
		<result property="menuName" column="menu_name"/>
		<result property="price" column="price"/>
	</resultMap>

	<resultMap id="placeImageMap" type="placeImage">
		<id property="placeImageId" column="place_image_id"/>
		<result property="fileName" column="file_name"/>
	</resultMap>
</mapper>